version: 0.2
phases:
  install:
    runtime-versions:
      docker: 18
  pre_build:
    commands:
      - export CLIENT_AWS_ACCOUNT=743404721710
      - aws sts assume-role --role-arn arn:aws:iam::$CLIENT_AWS_ACCOUNT:role/xilution-developer-role --role-session-name xilution-beta > aws-creds.json
      - export AWS_ACCESS_KEY_ID=`cat aws-creds.json | jq -r '.Credentials.AccessKeyId'`
      - export AWS_SECRET_ACCESS_KEY=`cat aws-creds.json | jq -r '.Credentials.SecretAccessKey'`
      - export AWS_SESSION_TOKEN=`cat aws-creds.json | jq -r '.Credentials.SessionToken'`
      - export IMAGE_NAME=`yq r $CODEBUILD_SRC_DIR_SourceCode/config.yaml name`
      - export IMAGE_VERSION=`yq r $CODEBUILD_SRC_DIR_SourceCode/config.yaml version`
      - aws ecr create-repository --repository-name xilution/$XILUTION_ORGANIZATION_ID/$IMAGE_NAME | true
  build:
    commands:
      - docker build -t xilution/$XILUTION_ORGANIZATION_ID/$IMAGE_NAME .
  post_build:
    commands:
      - aws ecr get-login --no-include-email | /bin/bash
      - docker tag xilution/$XILUTION_ORGANIZATION_ID/$IMAGE_NAME $CLIENT_AWS_ACCOUNT.dkr.ecr.$CLIENT_AWS_REGION.amazonaws.com/xilution/$XILUTION_ORGANIZATION_ID/$IMAGE_NAME:$IMAGE_VERSION
      - docker push $CLIENT_AWS_ACCOUNT.dkr.ecr.$CLIENT_AWS_REGION.amazonaws.com/xilution/$XILUTION_ORGANIZATION_ID/$IMAGE_NAME
      - |
        cat <<EOF >./image.yaml
        wordpress:
          image:
            repository: $CLIENT_AWS_ACCOUNT.dkr.ecr.$CLIENT_AWS_REGION.amazonaws.com/xilution/$XILUTION_ORGANIZATION_ID/$IMAGE_NAME
            tag: $IMAGE_VERSION
        EOF
artifacts:
  files:
    - image.yaml
